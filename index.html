<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Asistencia</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f8fb; }
    .card {
      max-width: 520px; margin: 32px auto; background: #fff; padding: 20px 20px 16px;
      border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.08);
    }
    h2 { margin: 0 0 8px; font-weight: 700; }
    p  { margin: 0 0 8px; color: #333; }
    .muted { color: #6b7280; }
    .err   { color: #b91c1c; }
    .ok    { color: #065f46; }
    .row { display: flex; gap: 8px; align-items: center; }
    input[type="text"] {
      width: 100%; font-size: 16px; padding: 12px 12px;
      border: 1px solid #e5e7eb; border-radius: 10px; outline: none;
    }
    input[type="text"].bad { border-color: #ef4444; background: #fff7f7; }
    button {
      padding: 12px 16px; border: 0; border-radius: 12px; font-weight: 700;
      background: #111827; color: white; cursor: pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,.12);
    }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .pill {
      display: none; font-size: 16px; padding: 12px; border-radius: 12px; font-weight: 800;
      background: #d1fae5; color: #065f46; border: 1px solid #86efac; margin-bottom: 10px;
    }
    .status { min-height: 22px; }
    .tips { font-size: 12px; color: #555; }
    .actions { display:flex; gap:8px; margin-top:6px; }
    .secondary { background:#374151; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Registro de Asistencia</h2>
    <p class="muted">Preparando…</p>

    <div id="okPill" class="pill">✅ ¡Asistencia registrada correctamente! Tu registro quedó guardado.</div>

    <div id="form">
      <p>Ingresá tu legajo para registrar asistencia.</p>
      <div class="row" style="margin-top:8px">
        <input id="legajo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Legajo" autocomplete="one-time-code" />
        <button id="btn">Enviar</button>
      </div>
      <p id="status" class="status muted" style="margin-top:6px">Buscando señal…</p>
      <div class="actions">
        <button id="retry" class="secondary" type="button">Reintentar</button>
      </div>
      <div id="tips" class="tips" style="display:none; margin-top:6px">
        • Activá Wi-Fi para mejorar la precisión.<br>
        • Abrí la app “Mapas” y esperá unos segundos.<br>
        • Quitá el ahorro de batería y permití “Ubicación precisa”.<br>
        • Si denegaste el permiso, habilitalo en los ajustes del navegador.
      </div>
    </div>
  </div>

  <script>
    const WEBAPP = 'https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXXXXX/exec'; // <-- PONÉ TU /exec AQUÍ
    const TOKEN = new URLSearchParams(location.search).get('token') || '';

    let geo = { lat: null, lon: null, accuracy: null, ts: 0 };
    let challenge = null;
    let sending = false;
    let watchId = null;
    let lockStatus = false; // evita que applyPos pise mensajes importantes

    const MAX_WAIT_TOTAL_MS   = 30000;
    const QUICK_TIMEOUT_MS    = 4000;
    const WATCH_TIMEOUT_MS    = 25000;
    const LASTKNOWN_MAX_AGEMS = 5*60*1000;
    const ACCEPTABLE_ACC_M    = 300;
    const HARD_MAX_ACC_M      = 1200;

    function $(id){ return document.getElementById(id); }

    function setStatus(t, cls, lock = false) {
      const el = $('status');
      el.className = 'status ' + (cls || '');
      el.textContent = t || '';
      lockStatus = lock;
    }

    function markInputError(){ const i=$('legajo'); i.classList.add('bad'); i.focus(); i.select(); }
    function clearInputError(){ $('legajo').classList.remove('bad'); }
    function readyToSend(){ return (!!geo.lat && !!geo.lon && !!challenge && !sending); }
    function updateButtonState(){ $('btn').disabled = !readyToSend(); }
    function getDeviceId() {
      const key = 'asistencia.deviceId';
      let v = localStorage.getItem(key);
      if (!v) { v = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Math.random()).slice(2); localStorage.setItem(key, v); }
      return v;
    }

    function applyPos(p) {
      if (lockStatus) return; // no pisar mensaje si está bloqueado
      const c = p.coords;
      geo = { lat: c.latitude, lon: c.longitude, accuracy: c.accuracy, ts: Date.now() };
      if (c.accuracy <= ACCEPTABLE_ACC_M) {
        setStatus("Listo para enviar", "ok");
      } else if (c.accuracy <= HARD_MAX_ACC_M) {
        setStatus("Ubicación obtenida (precisión ~" + Math.round(c.accuracy) + " m). Podés enviar.", "muted");
      } else {
        setStatus("Se obtuvo ubicación pero con precisión baja (~" + Math.round(c.accuracy) + " m). Podés intentar igual o reintentar.", "muted");
      }
      updateButtonState();
    }

    function handleGeoError(err){
      if (err && err.code === 1) {
        setStatus("Permiso de ubicación denegado. Activá la ubicación para continuar.", "err", true);
        showTips();
      }
    }

    function showTips(){ $('tips').style.display = 'block'; }

    function startGeo(){
      setStatus("Buscando señal…", "muted");
      $('tips').style.display = 'none';
      if (!('geolocation' in navigator)) { setStatus("Tu dispositivo no permite ubicación.", "err", true); showTips(); return; }

      navigator.geolocation.getCurrentPosition(
        (p)=>{ applyPos(p); },
        (e)=>handleGeoError(e),
        { enableHighAccuracy: false, timeout: QUICK_TIMEOUT_MS, maximumAge: LASTKNOWN_MAX_AGEMS }
      );

      try {
        watchId = navigator.geolocation.watchPosition(
          (p)=>{ applyPos(p); },
          (e)=>handleGeoError(e),
          { enableHighAccuracy: true, timeout: WATCH_TIMEOUT_MS, maximumAge: 0 }
        );
      } catch(e) {}

      setTimeout(() => {
        if (!geo.lat || !geo.lon) {
          navigator.geolocation.getCurrentPosition(
            (p)=>{ applyPos(p); },
            (e)=>{ setStatus("No pudimos obtener ubicación. Reintentá.", "err", true); showTips(); },
            { enableHighAccuracy: false, timeout: 4000, maximumAge: LASTKNOWN_MAX_AGEMS }
          );
        }
      }, MAX_WAIT_TOTAL_MS);

      updateButtonState();
      getChallenge().catch(e => setStatus(e.message, "err", true));
    }

    function stopGeo(){ if (watchId != null) { try { navigator.geolocation.clearWatch(watchId); } catch(e){} watchId = null; } }
    function retryGeo(){
      lockStatus = false; // desbloquear mensajes automáticos
      stopGeo();
      geo = { lat:null, lon:null, accuracy:null, ts:0 };
      updateButtonState();
      startGeo();
    }

    async function getChallenge(){
      const deviceId = getDeviceId();
      const url = `${WEBAPP}?action=challenge&token=${encodeURIComponent(TOKEN)}&deviceId=${encodeURIComponent(deviceId)}`;
      const r = await fetch(url);
      const j = await r.json();
      if(!j.ok) { setStatus(j.error || 'No se pudo preparar verificación', 'err', true); throw new Error(j.error || 'No se pudo preparar verificación'); }
      challenge = j; updateButtonState();
    }

    async function enviar(){
      const legajo = $('legajo').value.trim();
      if(!legajo){ setStatus('Ingresá tu legajo.', 'err', true); markInputError(); return; }
      if(geo.lat==null || geo.lon==null){ setStatus('Aún sin ubicación. Esperá y reintentá.', 'err', true); return; }

      sending = true; updateButtonState();
      setStatus('Enviando…', 'muted');

      if(!challenge){
        try { await getChallenge(); }
        catch(e){ setStatus(e.message, 'err', true); sending=false; updateButtonState(); return; }
      }

      try{
        const deviceId = getDeviceId();
        const body = new URLSearchParams({
          legajo,
          token: TOKEN,
          lat: String(geo.lat),
          lon: String(geo.lon),
          deviceId,
          nonce: challenge.nonce,
          accuracy: String(geo.accuracy ?? '')
        }).toString();

        const r = await fetch(WEBAPP, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body
        });

        const text = await r.text();
        let j; try { j = JSON.parse(text); } catch { throw new Error('Respuesta no-JSON del servidor: ' + text.slice(0,120)); }

        if (j.ok && j.success) {
          setStatus(j.message || '¡Listo! Asistencia registrada.', 'ok', true);
          $('form').style.display = 'none';
          $('okPill').style.display = 'block';
          stopGeo();
        } else {
          setStatus(j.error || j.message || 'Error desconocido', 'err', true);
        }
      } catch(e){
        setStatus(String(e.message||e), 'err', true);
      } finally {
        sending = false; updateButtonState();
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      $('btn').disabled = true;
      startGeo();
      $('btn').addEventListener('click', enviar);
      $('retry').addEventListener('click', retryGeo);
      $('legajo').addEventListener('input', clearInputError);
      $('legajo').addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter') enviar(); });
      if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({name:'geolocation'}).then(res=>{
          if (res.state === 'denied') { setStatus("Permiso de ubicación denegado. Activalo para continuar.", "err", true); showTips(); }
        }).catch(()=>{});
      }
    });
  </script>
</body>
</html>
