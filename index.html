<!doctype html>
<html lang="es">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Registro de Asistencia</title>
<!-- ===== Estilos (reemplaza tu <style> completo por este) ===== -->
<!-- ===== Estilos mobile-first ===== -->
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f7fa;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 400px;
    margin: 30px auto;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  h2 {
    margin-top: 0;
    color: #333;
    font-size: 22px;
  }
  input[type="text"] {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
  }
  button {
    background: #007BFF;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
  }
  button:hover {
    background: #0056b3;
  }
  #status {
    margin-top: 10px;
    font-size: 14px;
    color: #555;
  }
</style>


<!-- ===== Cuerpo (mantiene IDs y hooks JS) ===== -->
<div class="card">
  <h2>Registro de Asistencia</h2>
  <p class="sub">Ingresá tu legajo. La ubicación se valida automáticamente.</p>

  <!-- El JS ya lo muestra al registrar OK (display:inline-block). Dejamos mensaje fuerte. -->
  <div id="okPill">
    ✅ ¡Asistencia registrada correctamente!
    <span class="small">Tu registro quedó guardado. Podés cerrar esta página.</span>
  </div>

  <div id="form" class="formbox">
    <div class="row">
      <input
        id="legajo"
        type="text"
        inputmode="numeric"
        pattern="[0-9]*"
        autocomplete="one-time-code"
        placeholder="Ej: 12345" />
      <button id="btn" onclick="enviar()">Enviar</button>
    </div>

    <!-- aria-live para lectores y para que el mensaje “respire” en mobile -->
    <div id="status" class="status" aria-live="polite">Preparando…</div>

    <!-- Botón de reintento de GPS (tu JS ya lo usa si existe) -->
    <div class="actions">
      <button id="retry" class="secondary" type="button">Reintentar GPS</button>
    </div>
  </div>
</div>


<!-- ===== Marca tu <body> así (mantiene los mismos IDs y hooks JS) ===== -->
<div class="card">
  <h2>Registro de Asistencia</h2>
  <p class="sub">Ingresá tu legajo. La ubicación se valida automáticamente.</p>

  <div id="okPill" class="pill">✓ Enviado</div>

  <div id="form" class="formbox">
    <div class="row">
      <input id="legajo" type="text" inputmode="numeric" autocomplete="one-time-code"
             placeholder="Ej: 12345" />
      <button id="btn" onclick="enviar()">Enviar</button>
    </div>

    <div id="status" class="status">Preparando…</div>

    <!-- si usás reintento de GPS, este botón ya existe en tu JS -->
    <div class="actions">
      <button id="retry" class="secondary" type="button">Reintentar GPS</button>
    </div>
  </div>
</div>

<body>
  <div class="card">
    <h2>Registro</h2>
    <p id="status" class="status">Preparando…</p>
    <div class="row">
      <input id="legajo" placeholder="Legajo" inputmode="numeric">
      <button id="btn">Enviar</button>
    </div>
  </div>
<script>
const WEBAPP = 'https://script.google.com/macros/s/AKfycbwpT9s5Zewh1Me_IPU9AIfmHFy88GTJIG9LVeze-yl7-jUBsc4cqX2Z7NhJzow4mlg/exec'; // <-- tu /exec público
const urlParams = new URLSearchParams(location.search);
const TOKEN = urlParams.get('token') || ''; // el QR pone ?token=XXXX

let geo = {lat:null, lon:null, accuracy:null}, challenge = null;

function setStatus(t, cls){ const s=document.getElementById('status'); s.textContent=t; s.className='status '+(cls||''); }
function getDeviceId(){
  const k='asistencia.deviceId'; let v=localStorage.getItem(k);
  if(!v){ v=(crypto.randomUUID?crypto.randomUUID():String(Math.random()).slice(2)); localStorage.setItem(k,v); }
  return v;
}

// 1) Geolocalización
function startGeo(){
  if(!navigator.geolocation){ setStatus('Tu dispositivo no permite ubicación.','err'); return; }
  navigator.geolocation.getCurrentPosition(
    p=>{ geo={lat:p.coords.latitude, lon:p.coords.longitude, accuracy:p.coords.accuracy}; setStatus('Listo para enviar','ok'); },
    _=>setStatus('No se pudo obtener ubicación aún. Permití acceso o activá GPS/Wi-Fi.','err'),
    {enableHighAccuracy:true, timeout:15000, maximumAge:0}
  );
}

// 2) Obtener nonce
async function getChallenge(){
  const deviceId = getDeviceId();
  const r = await fetch(`${WEBAPP}?action=challenge&token=${encodeURIComponent(TOKEN)}&deviceId=${encodeURIComponent(deviceId)}`, {method:'GET'});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||'No se pudo preparar verificación');
  challenge = j;
}

// 3) Enviar asistencia
async function enviar(){
  const legajo = document.getElementById('legajo').value.trim();
  if(!legajo){ setStatus('Ingresá tu legajo.','err'); return; }
  if(geo.lat==null){ setStatus('Aún sin ubicación.','err'); return; }

  try{
    setStatus('Enviando…');
    if(!challenge) await getChallenge();

    const deviceId = getDeviceId();
    const form = new URLSearchParams({
      legajo,
      token: TOKEN,
      lat: String(geo.lat),
      lon: String(geo.lon),
      deviceId,
      nonce: challenge.nonce,
      accuracy: String(geo.accuracy ?? '')
    }).toString();
    
    const r = await fetch(WEBAPP, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: form
    });
    const j = await r.json();

    if(j.ok && j.success){
      setStatus(j.message || '¡Listo! Asistencia registrada.','ok');
    } else {
      throw new Error(j.error || j.message || 'Error desconocido');
    }
  }catch(e){
    setStatus(String(e.message||e),'err');
  }
}


document.getElementById('btn').addEventListener('click', enviar);
document.getElementById('legajo').addEventListener('keydown',(e)=>{ if(e.key==='Enter') enviar(); });

setStatus('Buscando señal…'); startGeo(); getChallenge().catch(()=>{});
</script>
</body>
</html>









