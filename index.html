<!doctype html>
<html lang="es">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Registro de Asistencia</title>
<!-- ===== Estilos (reemplaza tu <style> completo por este) ===== -->
<!-- ===== Estilos mobile-first ===== -->
<style>
  :root{
    --bg:#0b1020; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
    --ok:#10b981; --ok-ink:#052e1a; --err:#ef4444; --btn:#2563eb; --btn-ink:#fff;
    --ring:rgba(37,99,235,.35);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    color:var(--text);
    display:flex; align-items:center; justify-content:center;
    padding:clamp(16px,4vw,28px);
  }

  /* Tarjeta principal */
  .card{
    width:min(560px, 100%);
    background:var(--card);
    border:1px solid rgba(255,255,255,.07);
    border-radius:20px;
    padding:clamp(16px,4vw,24px);
    box-shadow:0 20px 60px rgba(0,0,0,.45);
  }
  h2{ margin:0 0 4px; font-size:clamp(20px,4.8vw,24px); letter-spacing:.2px }
  .sub{ margin:0 0 14px; color:var(--muted); font-size:clamp(13px,3.6vw,14px) }

  /* Form */
  .formbox{
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.06);
    border-radius:14px; padding:12px;
  }
  .row{ display:flex; gap:10px; align-items:center }
  input[type="text"]{
    flex:1; font-size:clamp(18px,5.2vw,20px);
    padding:14px 14px; color:var(--text);
    background:#0b1224; border:1px solid rgba(148,163,184,.28);
    border-radius:12px; outline:none; transition:.15s;
  }
  input[type="text"]:focus{ box-shadow:0 0 0 4px var(--ring); border-color:#60a5fa }
  input[type="text"].bad{ border-color:var(--err); box-shadow:0 0 0 4px rgba(239,68,68,.28) }
  input::placeholder{ color:#aab1c2 }

  button{
    min-height:48px; min-width:44px;
    padding:12px 16px; border:0; border-radius:12px; font-weight:700;
    font-size:clamp(16px,4.8vw,18px); line-height:1; letter-spacing:.2px;
    background:var(--btn); color:var(--btn-ink);
    box-shadow:0 10px 24px rgba(37,99,235,.35);
  }
  button:active{ transform:translateY(1px) }
  button[disabled]{ opacity:.6; box-shadow:none }
  .secondary{ background:#334155; box-shadow:none }

  /* Estado y ayuda */
  .status{ margin-top:10px; min-height:24px; font-size:clamp(14px,4vw,15px); color:var(--muted) }
  .status.ok{ color:var(--ok) } .status.err{ color:var(--err) }
  .actions{ display:flex; gap:8px; margin-top:10px }

  /* Panel de confirmación (usa #okPill existente) */
  #okPill{
    display:none; width:100%;
    background:#d1fae5; color:var(--ok-ink);
    border:1px solid #86efac; border-radius:16px;
    padding:14px; margin:8px 0 14px;
    font-size:clamp(16px,4.8vw,18px); font-weight:700;
  }
  #okPill .small{ display:block; font-weight:600; opacity:.9; margin-top:6px; font-size:clamp(13px,3.8vw,14px) }

  /* Safe areas (iOS notch) */
  .card{ padding-bottom: calc(clamp(16px,4vw,24px) + env(safe-area-inset-bottom)) }
</style>

<!-- ===== Cuerpo (mantiene IDs y hooks JS) ===== -->
<div class="card">
  <h2>Registro de Asistencia</h2>
  <p class="sub">Ingresá tu legajo. La ubicación se valida automáticamente.</p>

  <!-- El JS ya lo muestra al registrar OK (display:inline-block). Dejamos mensaje fuerte. -->
  <div id="okPill">
    ✅ ¡Asistencia registrada correctamente!
    <span class="small">Tu registro quedó guardado. Podés cerrar esta página.</span>
  </div>

  <div id="form" class="formbox">
    <div class="row">
      <input
        id="legajo"
        type="text"
        inputmode="numeric"
        pattern="[0-9]*"
        autocomplete="one-time-code"
        placeholder="Ej: 12345" />
      <button id="btn" onclick="enviar()">Enviar</button>
    </div>

    <!-- aria-live para lectores y para que el mensaje “respire” en mobile -->
    <div id="status" class="status" aria-live="polite">Preparando…</div>

    <!-- Botón de reintento de GPS (tu JS ya lo usa si existe) -->
    <div class="actions">
      <button id="retry" class="secondary" type="button">Reintentar GPS</button>
    </div>
  </div>
</div>


<!-- ===== Marca tu <body> así (mantiene los mismos IDs y hooks JS) ===== -->
<div class="card">
  <h2>Registro de Asistencia</h2>
  <p class="sub">Ingresá tu legajo. La ubicación se valida automáticamente.</p>

  <div id="okPill" class="pill">✓ Enviado</div>

  <div id="form" class="formbox">
    <div class="row">
      <input id="legajo" type="text" inputmode="numeric" autocomplete="one-time-code"
             placeholder="Ej: 12345" />
      <button id="btn" onclick="enviar()">Enviar</button>
    </div>

    <div id="status" class="status">Preparando…</div>

    <!-- si usás reintento de GPS, este botón ya existe en tu JS -->
    <div class="actions">
      <button id="retry" class="secondary" type="button">Reintentar GPS</button>
    </div>
  </div>
</div>

<body>
  <div class="card">
    <h2>Registro</h2>
    <p id="status" class="status">Preparando…</p>
    <div class="row">
      <input id="legajo" placeholder="Legajo" inputmode="numeric">
      <button id="btn">Enviar</button>
    </div>
  </div>
<script>
const WEBAPP = 'https://script.google.com/macros/s/AKfycbwpT9s5Zewh1Me_IPU9AIfmHFy88GTJIG9LVeze-yl7-jUBsc4cqX2Z7NhJzow4mlg/exec'; // <-- tu /exec público
const urlParams = new URLSearchParams(location.search);
const TOKEN = urlParams.get('token') || ''; // el QR pone ?token=XXXX

let geo = {lat:null, lon:null, accuracy:null}, challenge = null;

function setStatus(t, cls){ const s=document.getElementById('status'); s.textContent=t; s.className='status '+(cls||''); }
function getDeviceId(){
  const k='asistencia.deviceId'; let v=localStorage.getItem(k);
  if(!v){ v=(crypto.randomUUID?crypto.randomUUID():String(Math.random()).slice(2)); localStorage.setItem(k,v); }
  return v;
}

// 1) Geolocalización
function startGeo(){
  if(!navigator.geolocation){ setStatus('Tu dispositivo no permite ubicación.','err'); return; }
  navigator.geolocation.getCurrentPosition(
    p=>{ geo={lat:p.coords.latitude, lon:p.coords.longitude, accuracy:p.coords.accuracy}; setStatus('Listo para enviar','ok'); },
    _=>setStatus('No se pudo obtener ubicación aún. Permití acceso o activá GPS/Wi-Fi.','err'),
    {enableHighAccuracy:true, timeout:15000, maximumAge:0}
  );
}

// 2) Obtener nonce
async function getChallenge(){
  const deviceId = getDeviceId();
  const r = await fetch(`${WEBAPP}?action=challenge&token=${encodeURIComponent(TOKEN)}&deviceId=${encodeURIComponent(deviceId)}`, {method:'GET'});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||'No se pudo preparar verificación');
  challenge = j;
}

// 3) Enviar asistencia
async function enviar(){
  const legajo = document.getElementById('legajo').value.trim();
  if(!legajo){ setStatus('Ingresá tu legajo.','err'); return; }
  if(geo.lat==null){ setStatus('Aún sin ubicación.','err'); return; }

  try{
    setStatus('Enviando…');
    if(!challenge) await getChallenge();

    const deviceId = getDeviceId();
    const form = new URLSearchParams({
      legajo,
      token: TOKEN,
      lat: String(geo.lat),
      lon: String(geo.lon),
      deviceId,
      nonce: challenge.nonce,
      accuracy: String(geo.accuracy ?? '')
    }).toString();
    
    const r = await fetch(WEBAPP, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: form
    });
    const j = await r.json();

    if(j.ok && j.success){
      setStatus(j.message || '¡Listo! Asistencia registrada.','ok');
    } else {
      throw new Error(j.error || j.message || 'Error desconocido');
    }
  }catch(e){
    setStatus(String(e.message||e),'err');
  }
}


document.getElementById('btn').addEventListener('click', enviar);
document.getElementById('legajo').addEventListener('keydown',(e)=>{ if(e.key==='Enter') enviar(); });

setStatus('Buscando señal…'); startGeo(); getChallenge().catch(()=>{});
</script>
</body>
</html>








