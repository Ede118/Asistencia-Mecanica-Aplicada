<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Asistencia</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f8fb; }
    .card {
      max-width: 520px; margin: 32px auto; background: #fff; padding: 20px 20px 16px;
      border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.08);
    }
    h2 { margin: 0 0 8px; font-weight: 700; }
    p  { margin: 0 0 8px; color: #333; }
    .muted { color: #6b7280; }
    .err   { color: #b91c1c; }
    .ok    { color: #065f46; }
    .row { display: flex; gap: 8px; align-items: center; }
    input[type="text"] {
      width: 100%; font-size: 16px; padding: 12px 12px;
      border: 1px solid #e5e7eb; border-radius: 10px; outline: none;
    }
    input[type="text"].bad { border-color: #ef4444; background: #fff7f7; }
    button {
      padding: 12px 16px; border: 0; border-radius: 12px; font-weight: 700;
      background: #111827; color: white; cursor: pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,.12);
    }
    button[disabled] { opacity: .2; cursor: not-allowed; }
    .pill {
      display: none; font-size: 16px; padding: 12px; border-radius: 12px; font-weight: 800;
      background: #d1fae5; color: #065f46; border: 1px solid #86efac; margin-bottom: 10px;
    }
    .status { min-height: 22px; }
    .tips { font-size: 12px; color: #555; }
    .actions { display:flex; gap:8px; margin-top:6px; }
    .secondary { background:#374151; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Registro de Asistencia</h2>
    <!-- <p class="muted">Preparando‚Ä¶</p> -->

    <div id="okPill" class="pill">‚úÖ ¬°Asistencia registrada correctamente! Tu registro qued√≥ guardado.</div>

    <div id="form">
      <p>Ingres√° tu legajo para registrar asistencia.</p>
      <div class="row" style="margin-top:8px">
        <input id="legajo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Legajo" autocomplete="one-time-code" />
        <button id="btn">Enviar</button>
      </div>
      <p id="status" class="status muted" style="margin-top:6px" aria-live="polite">Buscando se√±al‚Ä¶</p>
      <div class="actions">
        <button id="retry" class="secondary" type="button">Reintentar</button>
      </div>
      <div id="tips" class="tips" style="display:none; margin-top:6px">
        ‚Ä¢ Activ√° Wi-Fi para mejorar la precisi√≥n.<br>
        ‚Ä¢ Abr√≠ la app ‚ÄúMapas‚Äù y esper√° unos segundos.<br>
        ‚Ä¢ Quit√° el ahorro de bater√≠a y permit√≠ ‚ÄúUbicaci√≥n precisa‚Äù.<br>
        ‚Ä¢ Si denegaste el permiso, habilitalo en los ajustes del navegador.
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const WEBAPP = 'https://script.google.com/macros/s/AKfycbxcf6YQODiYrQmugG_Anf_w-Ruw-UwAZyY_n98aOwrpgL00tafuHjyrG4pj_XXhkgR1/exec'; // <-- tu /exec
    const TOKEN = new URLSearchParams(location.search).get('token') || '';

    // ===== Estado =====
    let geo = { lat: null, lon: null, accuracy: null, ts: 0 };
    let challenge = null;
    let sending = false;
    let watchId = null;
    let lockStatus = false; // evita que el GPS pise mensajes importantes

    // Umbrales
    const MAX_WAIT_TOTAL_MS   = 30000;
    const QUICK_TIMEOUT_MS    = 4000;
    const WATCH_TIMEOUT_MS    = 25000;
    const LASTKNOWN_MAX_AGEMS = 5*60*1000;
    const ACCEPTABLE_ACC_M    = 300;
    const HARD_MAX_ACC_M      = 1200;

    // ===== Util =====
    const $ = (id)=>document.getElementById(id);
    function setStatus(t, cls, lock = false) {
      const el = $('status');
      el.className = 'status ' + (cls || '');
      el.textContent = t || '';
      lockStatus = lock;
    }
    function markInputError(){ const i=$('legajo'); i.classList.add('bad'); i.focus(); i.select(); }
    function clearInputError(){ $('legajo').classList.remove('bad'); }
    function readyToSend(){ return (!!geo.lat && !!geo.lon && !!challenge && !sending); }
    function updateButtonState(){ $('btn').disabled = !readyToSend(); }
    function getDeviceId(){
      const k='asistencia.deviceId'; let v=localStorage.getItem(k);
      if(!v){ v=(crypto && crypto.randomUUID?crypto.randomUUID():String(Math.random()).slice(2)); localStorage.setItem(k,v); }
      return v;
    }

    // ===== GEO =====
    function applyPos(p) {
      if (sending || lockStatus) return; // no pisar durante env√≠o o cuando hay error/√©xito bloqueado
      const c = p.coords;
      geo = { lat: c.latitude, lon: c.longitude, accuracy: c.accuracy, ts: Date.now() };
      if (c.accuracy <= ACCEPTABLE_ACC_M) {
        setStatus("Listo para enviar", "ok");
      } else if (c.accuracy <= HARD_MAX_ACC_M) {
        setStatus("Ubicaci√≥n obtenida (precisi√≥n ~" + Math.round(c.accuracy) + " m). Pod√©s enviar.", "muted");
      } else {
        setStatus("Se obtuvo ubicaci√≥n pero con precisi√≥n baja (~" + Math.round(c.accuracy) + " m). Pod√©s intentar igual o reintentar.", "muted");
      }
      updateButtonState();
    }
    function handleGeoError(err){
      if (err && err.code === 1) {
        setStatus("Permiso de ubicaci√≥n denegado. Activ√° la ubicaci√≥n para continuar.", "err", true);
        showTips();
      }
    }
    function showTips(){ $('tips').style.display = 'block'; }
    function stopGeo(){ if (watchId != null) { try { navigator.geolocation.clearWatch(watchId); } catch(e){} watchId = null; } }
    function retryGeo(){
      lockStatus = false; // desbloquear mensajes auto
      stopGeo();
      geo = { lat:null, lon:null, accuracy:null, ts:0 };
      updateButtonState();
      startGeo();
    }

    function startGeo(){
      setStatus("Buscando se√±al‚Ä¶", "muted");
      $('tips').style.display = 'none';
      if (!('geolocation' in navigator)) { setStatus("Tu dispositivo no permite ubicaci√≥n.", "err", true); showTips(); return; }

      navigator.geolocation.getCurrentPosition(
        (p)=>{ applyPos(p); },
        (e)=>handleGeoError(e),
        { enableHighAccuracy: false, timeout: QUICK_TIMEOUT_MS, maximumAge: LASTKNOWN_MAX_AGEMS }
      );

      try {
        watchId = navigator.geolocation.watchPosition(
          (p)=>{ applyPos(p); },
          (e)=>handleGeoError(e),
          { enableHighAccuracy: true, timeout: WATCH_TIMEOUT_MS, maximumAge: 0 }
        );
      } catch(e) {}

      setTimeout(() => {
        if (!geo.lat || !geo.lon) {
          navigator.geolocation.getCurrentPosition(
            (p)=>{ applyPos(p); },
            (e)=>{ setStatus("No pudimos obtener ubicaci√≥n. Reintent√°.", "err", true); showTips(); },
            { enableHighAccuracy: false, timeout: 4000, maximumAge: LASTKNOWN_MAX_AGEMS }
          );
        }
      }, MAX_WAIT_TOTAL_MS);

      updateButtonState();
      getChallenge().catch(e => setStatus(e.message, "err", true));

      if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({name:'geolocation'}).then(res=>{
          if (res.state === 'denied') { setStatus("Permiso de ubicaci√≥n denegado. Activalo para continuar.", "err", true); showTips(); }
        }).catch(()=>{});
      }
    }

    // ===== Backend =====
    async function getChallenge(){
      const deviceId = getDeviceId();
      const url = `${WEBAPP}?action=challenge&token=${encodeURIComponent(TOKEN)}&deviceId=${encodeURIComponent(deviceId)}`;
      const r = await fetch(url);
      const j = await r.json();
      if(!j.ok) { setStatus(j.error || 'No se pudo preparar verificaci√≥n', 'err', true); throw new Error(j.error || 'No se pudo preparar verificaci√≥n'); }
      challenge = j; updateButtonState();
    }

    async function enviar(){
      const legajo = $('legajo').value.trim();
      if(!legajo){ setStatus('Ingres√° tu legajo.', 'err', true); markInputError(); return; }
      if(geo.lat==null || geo.lon==null){ setStatus('A√∫n sin ubicaci√≥n. Esper√° y reintent√°.', 'err', true); return; }

      sending = true;                    // bloquear actualizaciones
      updateButtonState();
      setStatus('Enviando‚Ä¶', 'muted', true); // mantener visible ‚ÄúEnviando‚Ä¶‚Äù

      if(!challenge){
        try { await getChallenge(); }
        catch(e){ setStatus(e.message, 'err', true); sending=false; updateButtonState(); return; }
      }

      try{
        const deviceId = getDeviceId();
        const body = new URLSearchParams({
          legajo,
          token: TOKEN,
          lat: String(geo.lat),
          lon: String(geo.lon),
          deviceId,
          nonce: challenge.nonce,
          accuracy: String(geo.accuracy ?? '')
        }).toString();

        const r = await fetch(WEBAPP, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body
        });

        const text = await r.text();
        let j; try { j = JSON.parse(text); } catch { throw new Error('Respuesta no-JSON del servidor: ' + text.slice(0,120)); }

        if (j.ok && j.success) {
          setStatus(j.message || '¬°Listo! Asistencia registrada.', 'ok', true);
          $('form').style.display = 'none';
          // üëá NUEVO: mostrar el texto devuelto por backend
          $('okPill').textContent = j.message || '¬°Asistencia registrada correctamente! Tu registro qued√≥ guardado.';
          $('okPill').style.display = 'block';
          stopGeo();
        } else {
          setStatus(j.error || j.message || 'Error desconocido', 'err', true);
        }

      } catch(e){
        setStatus(String(e.message||e), 'err', true);
      } finally {
        sending = false; // ya no se est√° enviando, pero mantenemos lock hasta que toquen Reintentar
        updateButtonState();
      }
    }

    // ===== Init =====
    window.addEventListener('DOMContentLoaded', () => {
      $('btn').disabled = true;
      $('btn').addEventListener('click', enviar);
      $('retry').addEventListener('click', retryGeo);
      $('legajo').addEventListener('input', clearInputError);
      $('legajo').addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter') enviar(); });
      startGeo();
    });
  </script>
</body>
</html>




