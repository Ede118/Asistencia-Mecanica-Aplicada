<!doctype html>
<html lang="es">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Registro de Asistencia</title>
<!-- ===== Estilos (reemplaza tu <style> completo por este) ===== -->
<style>
  :root{
    --bg:#0b1020;            /* fondo app */
    --card:#0f172a;          /* tarjeta */
    --muted:#94a3b8;         /* texto secundario */
    --text:#e2e8f0;          /* texto principal */
    --accent:#22c55e;        /* ok */
    --warn:#f59e0b;          /* aviso */
    --err:#ef4444;           /* error */
    --btn:#2563eb;           /* botón primario */
    --btn-2:#334155;         /* botón secundario */
    --ring:rgba(59,130,246,.5);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1200px 800px at 80% -10%, #172554 0%, transparent 60%) , var(--bg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    color:var(--text);
    display:flex; align-items:center; justify-content:center; padding:28px;
  }
  .card{
    width:min(520px, 92vw);
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)) , var(--card);
    border-radius:20px; padding:22px 20px 18px;
    box-shadow: 0 18px 50px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.06);
    backdrop-filter: blur(6px);
  }
  h2{margin:0 0 6px; letter-spacing:.3px; font-size:22px}
  .sub{margin:0 0 14px; color:var(--muted); font-size:14px}
  .row{display:flex; gap:10px; align-items:center}
  input[type="text"]{
    flex:1; font-size:16px; padding:12px 14px; color:var(--text);
    background:#0b1224; border:1px solid rgba(148,163,184,.25); border-radius:12px;
    outline:none; transition:.15s ease;
  }
  input[type="text"]:focus{ box-shadow:0 0 0 4px var(--ring); border-color:#60a5fa }
  input[type="text"].bad{ border-color:var(--err); box-shadow:0 0 0 4px rgba(239,68,68,.25) }
  button{
    padding:12px 16px; border:0; border-radius:12px; font-weight:700;
    color:#fff; background:var(--btn); cursor:pointer; transition:.15s ease;
    box-shadow: 0 8px 18px rgba(37,99,235,.35);
  }
  button:hover{ transform: translateY(-1px); box-shadow: 0 12px 22px rgba(37,99,235,.45);}
  button:active{ transform: translateY(0); }
  button[disabled]{ opacity:.6; cursor:not-allowed; transform:none; box-shadow:none }
  .secondary{ background:var(--btn-2); box-shadow:none }
  .status{ margin-top:10px; min-height:22px; font-size:14px; color:var(--muted) }
  .status.ok{ color:var(--accent) }
  .status.err{ color:var(--err) }
  .status.warn{ color:var(--warn) }
  .pill{
    display:none; margin:6px 0 10px; font-size:13px; font-weight:700;
    color:#052e1a; background:#bbf7d0; border:1px solid #86efac;
    padding:6px 10px; border-radius:999px; width:max-content;
  }
  .actions{ display:flex; gap:8px; margin-top:8px }
  /* “tarjeta” del formulario para separación visual */
  .formbox{
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.06);
    border-radius:14px; padding:14px;
  }
</style>

<!-- ===== Marca tu <body> así (mantiene los mismos IDs y hooks JS) ===== -->
<div class="card">
  <h2>Registro de Asistencia</h2>
  <p class="sub">Ingresá tu legajo. La ubicación se valida automáticamente.</p>

  <div id="okPill" class="pill">✓ Enviado</div>

  <div id="form" class="formbox">
    <div class="row">
      <input id="legajo" type="text" inputmode="numeric" autocomplete="one-time-code"
             placeholder="Ej: 12345" />
      <button id="btn" onclick="enviar()">Enviar</button>
    </div>

    <div id="status" class="status">Preparando…</div>

    <!-- si usás reintento de GPS, este botón ya existe en tu JS -->
    <div class="actions">
      <button id="retry" class="secondary" type="button">Reintentar GPS</button>
    </div>
  </div>
</div>

<body>
  <div class="card">
    <h2>Registro</h2>
    <p id="status" class="status">Preparando…</p>
    <div class="row">
      <input id="legajo" placeholder="Legajo" inputmode="numeric">
      <button id="btn">Enviar</button>
    </div>
  </div>
<script>
const WEBAPP = 'https://script.google.com/macros/s/AKfycbwpT9s5Zewh1Me_IPU9AIfmHFy88GTJIG9LVeze-yl7-jUBsc4cqX2Z7NhJzow4mlg/exec'; // <-- tu /exec público
const urlParams = new URLSearchParams(location.search);
const TOKEN = urlParams.get('token') || ''; // el QR pone ?token=XXXX

let geo = {lat:null, lon:null, accuracy:null}, challenge = null;

function setStatus(t, cls){ const s=document.getElementById('status'); s.textContent=t; s.className='status '+(cls||''); }
function getDeviceId(){
  const k='asistencia.deviceId'; let v=localStorage.getItem(k);
  if(!v){ v=(crypto.randomUUID?crypto.randomUUID():String(Math.random()).slice(2)); localStorage.setItem(k,v); }
  return v;
}

// 1) Geolocalización
function startGeo(){
  if(!navigator.geolocation){ setStatus('Tu dispositivo no permite ubicación.','err'); return; }
  navigator.geolocation.getCurrentPosition(
    p=>{ geo={lat:p.coords.latitude, lon:p.coords.longitude, accuracy:p.coords.accuracy}; setStatus('Listo para enviar','ok'); },
    _=>setStatus('No se pudo obtener ubicación aún. Permití acceso o activá GPS/Wi-Fi.','err'),
    {enableHighAccuracy:true, timeout:15000, maximumAge:0}
  );
}

// 2) Obtener nonce
async function getChallenge(){
  const deviceId = getDeviceId();
  const r = await fetch(`${WEBAPP}?action=challenge&token=${encodeURIComponent(TOKEN)}&deviceId=${encodeURIComponent(deviceId)}`, {method:'GET'});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||'No se pudo preparar verificación');
  challenge = j;
}

// 3) Enviar asistencia
async function enviar(){
  const legajo = document.getElementById('legajo').value.trim();
  if(!legajo){ setStatus('Ingresá tu legajo.','err'); return; }
  if(geo.lat==null){ setStatus('Aún sin ubicación.','err'); return; }

  try{
    setStatus('Enviando…');
    if(!challenge) await getChallenge();

    const deviceId = getDeviceId();
    const form = new URLSearchParams({
      legajo,
      token: TOKEN,
      lat: String(geo.lat),
      lon: String(geo.lon),
      deviceId,
      nonce: challenge.nonce,
      accuracy: String(geo.accuracy ?? '')
    }).toString();
    
    const r = await fetch(WEBAPP, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: form
    });
    const j = await r.json();

    if(j.ok && j.success){
      setStatus(j.message || '¡Listo! Asistencia registrada.','ok');
    } else {
      throw new Error(j.error || j.message || 'Error desconocido');
    }
  }catch(e){
    setStatus(String(e.message||e),'err');
  }
}


document.getElementById('btn').addEventListener('click', enviar);
document.getElementById('legajo').addEventListener('keydown',(e)=>{ if(e.key==='Enter') enviar(); });

setStatus('Buscando señal…'); startGeo(); getChallenge().catch(()=>{});
</script>
</body>
</html>







