<!doctype html>
<html lang="es">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Registro de Asistencia</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;background:#f6f8fb;margin:0}
  .card{max-width:520px;margin:32px auto;background:#fff;padding:20px;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
  .row{display:flex;gap:8px;align-items:center}
  input{flex:1;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px}
  button{padding:10px 14px;border:0;border-radius:12px;font-weight:600;background:#111827;color:#fff}
  .status{min-height:22px;color:#6b7280}
  .ok{color:#065f46} .err{color:#b91c1c}
</style>
<body>
  <div class="card">
    <h2>Registro</h2>
    <p id="status" class="status">Preparando…</p>
    <div class="row">
      <input id="legajo" placeholder="Legajo" inputmode="numeric">
      <button id="btn">Enviar</button>
    </div>
  </div>
<script>
const WEBAPP = 'https://script.google.com/macros/s/AKfycbwbRO9e63gSRoHmt8_8vfnwH0geiN0dfw96rQ_KfCvY5kR0DmLwpXNtBAZyEQ0UyzaZ/exec'; // <-- tu /exec público
const urlParams = new URLSearchParams(location.search);
const TOKEN = urlParams.get('token') || ''; // el QR pone ?token=XXXX

let geo = {lat:null, lon:null, accuracy:null}, challenge = null;

function setStatus(t, cls){ const s=document.getElementById('status'); s.textContent=t; s.className='status '+(cls||''); }
function getDeviceId(){
  const k='asistencia.deviceId'; let v=localStorage.getItem(k);
  if(!v){ v=(crypto.randomUUID?crypto.randomUUID():String(Math.random()).slice(2)); localStorage.setItem(k,v); }
  return v;
}

// 1) Geolocalización
function startGeo(){
  if(!navigator.geolocation){ setStatus('Tu dispositivo no permite ubicación.','err'); return; }
  navigator.geolocation.getCurrentPosition(
    p=>{ geo={lat:p.coords.latitude, lon:p.coords.longitude, accuracy:p.coords.accuracy}; setStatus('Listo para enviar','ok'); },
    _=>setStatus('No se pudo obtener ubicación aún. Permití acceso o activá GPS/Wi-Fi.','err'),
    {enableHighAccuracy:true, timeout:15000, maximumAge:0}
  );
}

// 2) Obtener nonce
async function getChallenge(){
  const deviceId = getDeviceId();
  const r = await fetch(`${WEBAPP}?action=challenge&token=${encodeURIComponent(TOKEN)}&deviceId=${encodeURIComponent(deviceId)}`, {method:'GET'});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||'No se pudo preparar verificación');
  challenge = j;
}

// 3) Enviar asistencia
async function enviar(){
  const legajo = document.getElementById('legajo').value.trim();
  if(!legajo){ setStatus('Ingresá tu legajo.','err'); return; }
  if(geo.lat==null){ setStatus('Aún sin ubicación.','err'); return; }
  try{
    setStatus('Enviando…');
    if(!challenge) await getChallenge(); // fresco
    const deviceId = getDeviceId();
    const r = await fetch(WEBAPP, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ legajo, token:TOKEN, lat:geo.lat, lon:geo.lon, deviceId, nonce:challenge.nonce, accuracy:geo.accuracy })
    });
    const j = await r.json();
    if(j.ok && j.success){ setStatus(j.message || '¡Listo! Asistencia registrada.','ok'); }
    else { throw new Error(j.error || j.message || 'Error desconocido'); }
  }catch(e){
    setStatus(String(e.message||e),'err');
  }
}

document.getElementById('btn').addEventListener('click', enviar);
document.getElementById('legajo').addEventListener('keydown',(e)=>{ if(e.key==='Enter') enviar(); });

setStatus('Buscando señal…'); startGeo(); getChallenge().catch(()=>{});
</script>
</body>
</html>



